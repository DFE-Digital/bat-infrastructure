groups:
- name: High CPU
  rules:
%{ for app_name, app_config in apps ~}
  - alert: High-CPU-${app_name}
    expr: avg by ( app ) (cpu{app=~"${app_name}"}) > 50
    for: 5m
    annotations:
      summary:     ${app_name} High CPU Alert
      dashboard:   ${grafana_dashboard_url}&var-Applications=${app_name}
      description: "CPU usage has increased in the last 5 minutes (current value: {{ $value }}%)"
    labels:
      environment: production
      severity:    high
      app:         ${app_name}
%{ endfor ~}

- name: Memory Utilisation
  rules:
%{ for app_name, app_config in apps ~}
  - alert: High-Memory-Utilisation-${app_name}
    expr: avg by ( app ) (memory_utilization{app=~"${app_name}"}) > 60
    for: 5m
    annotations:
      summary:     ${app_name} high memory utilization
      dashboard:   ${grafana_dashboard_url}&var-Applications=${app_name}
      description: "Memory utilization has increased in the last 5 minutes (current value: {{ $value }}%)"
    labels:
      severity:    high
      app:         ${app_name}
      environment: production
%{ endfor ~}

- name: Disk Utilisation
  rules:
%{ for app_name, app_config in apps ~}
  - alert: High-Disk-Utilisation-${app_name}
    expr: avg by ( app ) ( disk_utilization{ app=~"${app_name}" }) > 60
    for: 5m
    annotations:
      summary:     ${app_name} high disk utilization
      dashboard:   ${grafana_dashboard_url}&var-Applications=${app_name}
      description: "Disk utilization has increased in the last 5 minutes (current value: {{ $value }})%"
    labels:
      severity:    high
      app:         ${app_name}
      environment: production
%{ endfor ~}

- name: App Crashes
  rules:
%{ for app_name, app_config in apps ~}
  - alert: App-Crash-${app_name}
    expr: rate(crash{app=~"${app_name}"}[1m])*60 > 1
    for: 5m
    annotations:
      summary:     At least one instance of ${app_name} has crashed in the last 5 mins
      dashboard:   ${grafana_dashboard_url}&var-Applications=${app_name}
      description: At least one instance of ${app_name} has crashed in the last 5 mins
    labels:
      severity:    high
      app:         ${app_name}
      environment: production
%{ endfor ~}

- name: Elevated Request Failures
  rules:
%{ for app_name, app_config in apps ~}
  - alert: Request-Failures-${app_name}
    expr:  sum(rate(requests{app="${app_name}", status_range=~"0xx|4xx|5xx"}[5m]))*60 > 25
    for: 5m
    annotations:
      summary:     Failed requests count
      dashboard:   ${grafana_dashboard_url}&var-Applications=${app_name}
      description: "Number({{ $value }}) of non success status codes too high in the last 5 mins for ${app_name}"
    labels:
      severity:    high
      app:         ${app_name}
      environment: production
%{ endfor ~}

- name: Average Response Time
  rules:
%{ for app_name, app_config in apps ~}
  - alert: Response-Times-${app_name}
    expr:  histogram_quantile(0.95, sum(rate(response_time_bucket{app="${app_name}", status_range="2xx"}[5m])) by (le)) > %{ if app_config.response_threshold == null }1%{ else }${app_config.response_threshold}%{ endif }
    for: 5m
    annotations:
      summary:     Slow running requests
      dashboard:   ${grafana_dashboard_url}&var-Applications=${app_name}
      description: "Requests in the 95 percentile taking longer than %{ if app_config.response_threshold == null }1%{ else }${app_config.response_threshold}%{ endif } seconds (current value: {{ humanize $value}}s )"
    labels:
      severity:    high
      app:         ${app_name}
      environment: production
%{ endfor ~}

- name: Redis Memory Utilisation
  rules:
%{ for redis_instance in alertable_redis_instances ~}
  - alert: Redis memory utilisation high (instance - ${redis_instance})
    expr: (redis_memory_used_bytes{instance=~"${redis_instance}"} / redis_memory_max_bytes{instance=~"${redis_instance}"}) > 0.60
    for: 4m
    annotations:
      summary:     ${redis_instance} high memory utilization
      dashboard:   ${redis_dashboard_url}&var-instance=${redis_instance}.london.cloudapps.digital:443
      description: "Redis Memory utilization is greater than 60% (current value: {{ $value }})"
    labels:
      severity:    high
      app:         ${redis_instance}
      environment: production
%{ endfor ~}

- name: Postgres Memory Available
  rules:
%{ for postgres_instance in alertable_postgres_instances ~}
  - alert: Postgres memory available low (instance - ${postgres_instance})
    expr: freeable_memory_bytes{service=~"${postgres_instance}"} < (512 * 1024 * 1024)
    for: 5m
    annotations:
      summary:     ${postgres_instance} low memory available
      dashboard:   ${postgres_dashboard_url}&var-Services=${postgres_instance}
      description: "Postgres Memory available is less than 512M (current value: {{ $value }})"
    labels:
      severity:    high
      app:         ${postgres_instance}
      environment: production
%{ endfor ~}

- name: Postgres CPU Utilisation
  rules:
%{ for postgres_instance in alertable_postgres_instances ~}
  - alert: Postgres CPU Utilisation high (instance - ${postgres_instance})
    expr: cpu_percent{service=~"${postgres_instance}"} > 60
    for: 5m
    annotations:
      summary:     ${postgres_instance} high CPU Utilisation
      dashboard:   ${postgres_dashboard_url}&var-Services=${postgres_instance}
      description: "Postgres CPU Utilisation is above 60% (current value: {{ $value }})"
    labels:
      severity:    high
      app:         ${postgres_instance}
      environment: production
%{ endfor ~}

- name: Postgres Storage Utilisation
  rules:
%{ for postgres_instance in alertable_postgres_instances ~}
  - alert: Postgres Storage available low (instance - ${postgres_instance})
    expr: free_storage_space_bytes{service=~"${postgres_instance}"} < (1024 * 1024 * 1024)
    for: 5m
    annotations:
      summary:     ${postgres_instance} low storage available
      dashboard:   ${postgres_dashboard_url}&var-Services=${postgres_instance}
      description: "Postgres Storage available is less than 1G (current value: {{ $value }})"
    labels:
      severity:    high
      app:         ${postgres_instance}
      environment: production
%{ endfor ~}
